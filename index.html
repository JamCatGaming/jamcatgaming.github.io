!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cat Beat: Fever Stars</title>
    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #483D8B; /* DarkSlateBlue */
            --container-bg: #E6E6FA; /* Lavender */
            --primary-accent: #9370DB; /* MediumPurple */
            --hit-zone-color: #00FA9A; /* MediumSpringGreen */
            --fever-glow: #FFD700; /* Gold */
            --danger-color: #FF6347; /* Tomato */
            --text-color: #333;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            font-family: 'Arial', 'Helvetica Neue', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            background-color: var(--container-bg);
            border: 5px solid var(--primary-accent);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transition: box-shadow 0.5s ease, transform 0.1s;
        }
        #game-container.fever-time { box-shadow: 0 0 30px var(--fever-glow); }
        #game-container.shake { animation: shake 0.3s; }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); }
        }

        .lane-container { display: flex; width: 100%; height: 100%; }
        .lane {
            flex: 1; height: 100%; position: relative;
            border-left: 2px dashed rgba(0,0,0,0.1); border-right: 2px dashed rgba(0,0,0,0.1);
        }

        #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 24px; font-weight: bold; color: var(--text-color); z-index: 10; }
        #lives-container { display: flex; align-items: center; }
        #shield-icon { font-size: 28px; margin-left: 10px; opacity: 0; transition: opacity 0.3s; text-shadow: 0 0 10px #3498db; }
        #shield-icon.active { opacity: 1; }

        #cat { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 100px; z-index: 25; }
        #cat.happy { animation: head-bob 0.4s ease-in-out; }
        #cat.sad { animation: head-shake 0.4s ease-in-out; }
        @keyframes head-bob { 0%, 100% { transform: translateX(-50%) rotate(0deg); } 25% { transform: translateX(-50%) rotate(-10deg); } 75% { transform: translateX(-50%) rotate(10deg); } }
        @keyframes head-shake { 0%, 100% { transform: translateX(-50%); } 25% { transform: translateX(-55%) rotate(-5deg); } 75% { transform: translateX(-45%) rotate(5deg); } }

        .note { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; font-size: 50px; text-align: center; line-height: 60px; animation: fall linear; }
        @keyframes fall { from { top: -60px; } to { top: 100vh; } }

        .target-line { position: absolute; bottom: 120px; left: 0; width: 100%; height: 60px; background-color: rgba(0, 250, 154, 0.2); border-top: 3px solid var(--hit-zone-color); border-bottom: 3px solid var(--hit-zone-color); z-index: 5; transition: transform 0.1s; }
        .key-indicator { position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); font-size: 40px; color: var(--primary-accent); opacity: 0.4; transition: all 0.1s ease-out; z-index: 6; }
        .key-indicator.hittable { opacity: 1; transform: translateX(-50%) scale(1.2); text-shadow: 0 0 10px white; }
        .key-indicator.pressed { transform: translateX(-50%) scale(0.9); transition-duration: 0.05s; }

        #fever-bar-container { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); width: 90%; height: 20px; background: rgba(0,0,0,0.2); border: 2px solid var(--primary-accent); border-radius: 10px; z-index: 20; overflow: hidden; }
        #fever-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); transition: width 0.2s ease-out; }
        #fever-bar.depleting { background: linear-gradient(90deg, #FFFFFF, #FFD700); transition: width 10s linear !important; }

        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 100; }
        #start-screen h1 { margin: 0; font-size: 3em; }
        #start-screen p { font-size: 1.2em; line-height: 1.5; max-width: 80%; }
        #high-score-display { font-size: 1.3em; color: var(--fever-glow); margin-top: 10px; }
        #start-button { padding: 15px 30px; font-size: 1.5em; border-radius: 10px; border: none; cursor: pointer; background-color: var(--danger-color); color: white; font-weight: bold; margin-top: 20px; transition: background-color 0.2s; }
        #start-button:hover { background-color: #e55337; }

        .floating-text, .particle { position: absolute; pointer-events: none; z-index: 30; }
        .floating-text { font-size: 22px; font-weight: bold; animation: float-up 1s ease-out forwards; }
        @keyframes float-up { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-60px); } }
        .particle { color: var(--fever-glow); text-shadow: 0 0 5px white; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="lane-container">
            <div class="lane"> <div class="target-line"></div> <div class="key-indicator">‚¨ÖÔ∏è</div></div>
            <div class="lane"> <div class="target-line"></div> <div class="key-indicator">‚¨áÔ∏è</div></div>
            <div class="lane"> <div class="target-line"></div> <div class="key-indicator">‚û°Ô∏è</div></div>
        </div>
        <img id="cat" src="https://coin-images.coingecko.com/coins/images/51446/large/jamcat.jpg?1731602538" alt="Cute Cat">
        <div id="ui">
            <span id="score"></span><span id="combo"></span>
            <div id="lives-container"><span id="lives"></span><span id="shield-icon">üõ°Ô∏è</span></div>
        </div>
        <div id="fever-bar-container"><div id="fever-bar"></div></div>
        <div id="start-screen">
            <h1>Jam Cat Beat</h1>
            <p>Use <b>‚¨ÖÔ∏è ‚¨áÔ∏è ‚û°Ô∏è</b> to catch falling items in the correct lane.<br>
            Build your combo and fill the meter for <b>Fever Time!</b></p>
            <div id="high-score-display">High Score: ...</div>
            <p id="final-score" style="display:none;"></p>
            <button id="start-button">Start Game</button>
        </div>
    </div>

    <script>
        // --- TELEGRAM & SUPABASE INTEGRATION ---
        const tg = window.Telegram.WebApp;
        // --> –í–°–¢–ê–í–¨–¢–ï –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó SUPABASE –°–Æ–î–ê <--
        const SUPABASE_URL = 'https://kefcmxtlllmatffumhyc.supabase.co'; // –ù–∞–ø—Ä–∏–º–µ—Ä: 'https://xxxxxxxx.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlZmNteHRsbGxtYXRmZnVtaHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4NDQyMjYsImV4cCI6MjA1ODQyMDIyNn0.W22ul6CQOM4R4bp8x16bnK3NcdXkFKTP8K_Y6a1Bzdo'; // –î–ª–∏–Ω–Ω—ã–π –∫–ª—é—á anon public

        let currentUser;
	const { createClient } = supabase;

        if (SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error("Supabase credentials are not set!");
            document.getElementById('high-score-display').textContent = 'Error: DB not configured.';
        }

        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        const lanes = document.querySelectorAll('.lane');
        const cat = document.getElementById('cat');
        const scoreDisplay = document.getElementById('score');
        const comboDisplay = document.getElementById('combo');
        const livesDisplay = document.getElementById('lives');
        const shieldIcon = document.getElementById('shield-icon');
        const feverBar = document.getElementById('fever-bar');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const finalScoreDisplay = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score-display');
        const keyIndicators = document.querySelectorAll('.key-indicator');

        // --- Game State & Config ---
        let score, combo, lives, hasShield, feverMeter, isFeverTime, highScore;
        let noteSpeed, noteSpawnInterval;
        let gameIsActive = false, noteSpawner = null, animationFrameId = null, feverParticleSpawner = null;
        const FEVER_MAX = 100, KEY_MAP = { 'ArrowLeft': 0, 'ArrowDown': 1, 'ArrowRight': 2 };
        const items = {
            food: [ {e: 'üêü'}, {e: 'üçó'}, {e: 'ü•©'} ],
            junk: [ {e: 'üë¢'}, {e: 'üß±'}, {e: 'üåµ'} ],
            powerup: [ {e: 'üõ°Ô∏è', type: 'shield'}, {e: '‚ù§Ô∏è', type: 'heart'} ],
            special: [ {e: '‚ú®üêü', type: 'goldfish'} ]
        };

        // --- Game Flow & Main Loop ---
        function startGame() {
            score = 0; combo = 1; lives = 3; hasShield = false;
            noteSpeed = 3.5; noteSpawnInterval = 1200;
            feverMeter = 0; isFeverTime = false;
            gameIsActive = true; updateUI();
            startScreen.style.display = 'none';
            document.querySelectorAll('.note, .particle').forEach(n => n.remove());
            noteSpawner = setInterval(createNote, noteSpawnInterval);
            gameLoop();
        }

        function gameLoop() {
            if (!gameIsActive) return;
            updateKeyIndicators();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function createNote() {
            if (!gameIsActive) return;
            const item = getItem();
            const laneIndex = Math.floor(Math.random() * 3);
            const note = document.createElement('div');
            note.className = 'note';
            note.textContent = item.e;
            note.dataset.type = item.type;
            note.dataset.lane = laneIndex;
            note.style.animationDuration = `${noteSpeed}s`;
            note.addEventListener('animationend', () => {
                note.remove();
                if (gameIsActive && (item.type === 'food' || item.type === 'goldfish')) {
                    handleMiss(null); // –ü—Ä–æ–ø—É—Å–∫ –µ–¥—ã = –ø—Ä–æ–º–∞—Ö
                }
            });
            lanes[laneIndex].appendChild(note);
        }

        async function endGame() {
            gameIsActive = false;
            clearInterval(noteSpawner);
            cancelAnimationFrame(animationFrameId);
            if (isFeverTime) endFeverTime(true);

            if (score > highScore) {
                highScore = score;
                await saveUserHighScore(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –≤ Supabase
            }

            startScreen.style.display = 'flex';
            finalScoreDisplay.textContent = `Your final score: ${score}`;
            finalScoreDisplay.style.display = 'block';
            startButton.textContent = 'Play Again';
            highScoreDisplay.textContent = `High Score: ${highScore}`;
        }

        // --- NEW: Functions for Supabase Interaction ---
        async function fetchUserHighScore() {
            if (!supabase || !currentUser) {
                highScore = 0;
                highScoreDisplay.textContent = `High Score: 0`;
                return;
            }
            try {
                highScoreDisplay.textContent = 'Loading score...';
                const { data, error } = await supabase
                    .from('scores')
                    .select('high_score')
                    .eq('telegram_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = row not found
                    throw error;
                }

                highScore = data ? data.high_score : 0;
                highScoreDisplay.textContent = `High Score: ${highScore}`;

            } catch (error) {
                console.error('Error fetching high score:', error);
                highScore = 0;
                highScoreDisplay.textContent = 'Could not load score';
            }
        }

        async function saveUserHighScore() {
            if (!supabase || !currentUser) return;
            try {
                const { error } = await supabase
                    .from('scores')
                    .upsert({
                        telegram_id: currentUser.id,
                        username: currentUser.username,
                        high_score: highScore
                    }, { onConflict: 'telegram_id' });

                if (error) throw error;
                console.log('High score saved successfully!');

            } catch (error) {
                console.error('Error saving high score:', error);
            }
        }

        // --- Original Functions (mostly unchanged) ---
        function getItem() { /* ... unchanged ... */ }
        function handleKeyPress(e) { /* ... unchanged ... */ }
        function handleHit(points, feverGain, targetElement) { /* ... unchanged ... */ }
        function handleMiss(targetElement) { /* ... unchanged ... */ }
        function activatePowerup(type, targetElement) { /* ... unchanged ... */ }
        function updateFeverMeter(amount) { /* ... unchanged ... */ }
        function activateFeverTime() { /* ... unchanged ... */ }
        function endFeverTime(force = false) { /* ... unchanged ... */ }
        function updateKeyIndicators() { /* ... unchanged ... */ }
        function updateUI() { /* ... unchanged ... */ }
        function createFloatingText(text, element, color) { /* ... unchanged ... */ }
        function createHitParticles(count, element) { /* ... unchanged ... */ }
        function createFeverParticle() { /* ... unchanged ... */ }

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ Web App –≥–æ—Ç–æ–≤–æ
            tg.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º Web App –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–µ–º unsafe –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã.
            currentUser = tg.initDataUnsafe?.user;

            if (!currentUser) {
                // –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–µ –∏–∑ Telegram, —Å–æ–∑–¥–∞–µ–º "—Ñ–µ–π–∫–æ–≤–æ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
                console.warn("Not running in Telegram. Using mock user for testing.");
                currentUser = { id: 12345, username: 'testuser', first_name: 'Test' };
                document.getElementById('start-screen').querySelector('p').innerHTML += '<br><b style="color:yellow;">Running in test mode. Scores will not be saved correctly.</b>';
            }

            fetchUserHighScore();
        });

        startButton.addEventListener('click', startGame);
        document.addEventListener('keydown', handleKeyPress);

        // --- Copy-pasted original functions to keep the script complete ---
        // (These functions are identical to your original code)
        getItem = function() {
            if (isFeverTime) {
                const rand = Math.random();
                if (rand < 0.8) return { ...items.food[Math.floor(Math.random()*items.food.length)], type: 'food' };
                if (rand < 0.95) return { ...items.powerup[Math.floor(Math.random()*items.powerup.length)] };
                return { ...items.special[0] };
            }
            const rand = Math.random() * 100;
            if (rand < 55) return { ...items.food[Math.floor(Math.random()*items.food.length)], type: 'food' };
            if (rand < 85) return { ...items.junk[Math.floor(Math.random()*items.junk.length)], type: 'junk' };
            if (rand < 98) return { ...items.powerup[Math.floor(Math.random()*items.powerup.length)] };
            return { ...items.special[0] };
        }
        handleKeyPress = function(e) {
            if (!gameIsActive || !KEY_MAP.hasOwnProperty(e.key)) return;
            const laneIndex = KEY_MAP[e.key];
            const targetLine = lanes[laneIndex].querySelector('.target-line');
            const targetRect = targetLine.getBoundingClientRect();
            let noteHit = null;
            keyIndicators[laneIndex].classList.add('pressed');
            setTimeout(() => keyIndicators[laneIndex].classList.remove('pressed'), 100);
            lanes[laneIndex].querySelectorAll('.note').forEach(note => {
                const noteRect = note.getBoundingClientRect();
                if (noteRect.bottom > targetRect.top && noteRect.top < targetRect.bottom) noteHit = note;
            });
            if (noteHit) {
                const type = noteHit.dataset.type;
                switch(type) {
                    case 'food': handleHit(20, 10, targetLine); break;
                    case 'goldfish': handleHit(250, 30, targetLine); break;
                    case 'junk': handleMiss(targetLine); break;
                    case 'shield': activatePowerup('shield', targetLine); break;
                    case 'heart': activatePowerup('heart', targetLine); break;
                }
                noteHit.remove();
            }
        }
        handleHit = function(points, feverGain, targetElement) {
            const scoreMultiplier = isFeverTime ? 3 : 1;
            const finalPoints = points * combo * scoreMultiplier;
            score += finalPoints; combo++;
            if (!isFeverTime) updateFeverMeter(feverGain);
            noteSpeed = Math.max(1.0, noteSpeed - 0.03);
            cat.classList.remove('sad', 'happy'); void cat.offsetWidth; cat.classList.add('happy');
            createFloatingText(`+${finalPoints}`, targetElement, '#27ae60');
            createHitParticles(15, targetElement);
            updateUI();
        }
        handleMiss = function(targetElement) {
            if (hasShield) {
                hasShield = false; combo = Math.max(1, Math.floor(combo / 2));
                createFloatingText('SHIELD USED!', targetElement || lanes[1].querySelector('.target-line'), '#3498db');
                updateUI(); return;
            }
            lives--; combo = 1;
            if (isFeverTime) endFeverTime();
            cat.classList.remove('happy', 'sad'); void cat.offsetWidth; cat.classList.add('sad');
            gameContainer.classList.add('shake');
            setTimeout(() => gameContainer.classList.remove('shake'), 300);
            if (targetElement) {
                createFloatingText('MISS', targetElement, '#e74c3c');
            }
            if (lives <= 0) endGame();
            updateUI();
        }
        activatePowerup = function(type, targetElement) {
            let text = '';
            switch(type) {
                case 'shield': text = 'SHIELD UP!'; hasShield = true; break;
                case 'heart': if (lives < 5) { text = '+1 LIFE!'; lives++; } break;
            }
            if (text) createFloatingText(text, targetElement, '#3498db');
            updateUI();
        }
        updateFeverMeter = function(amount) {
            if (isFeverTime) return;
            feverMeter = Math.min(FEVER_MAX, feverMeter + amount);
            if (feverMeter === FEVER_MAX) activateFeverTime();
            updateUI();
        }
        activateFeverTime = function() {
            isFeverTime = true;
            gameContainer.classList.add('fever-time');
            feverParticleSpawner = setInterval(createFeverParticle, 150);
            feverBar.classList.add('depleting');
            feverBar.style.width = '100%';
            requestAnimationFrame(() => { feverBar.style.width = '0%'; });
            setTimeout(endFeverTime, 10000);
        }
        endFeverTime = function(force = false) {
            if (!isFeverTime && !force) return;
            isFeverTime = false; feverMeter = 0;
            gameContainer.classList.remove('fever-time');
            clearInterval(feverParticleSpawner);
            feverBar.classList.remove('depleting');
            updateUI();
        }
        updateKeyIndicators = function() {
            const hittableLanes = [false, false, false];
            document.querySelectorAll('.note').forEach(note => {
                const laneIndex = parseInt(note.dataset.lane, 10);
                const targetLine = lanes[laneIndex].querySelector('.target-line');
                const noteRect = note.getBoundingClientRect();
                const targetRect = targetLine.getBoundingClientRect();
                if (noteRect.bottom > targetRect.top && noteRect.top < targetRect.bottom) {
                    hittableLanes[laneIndex] = true;
                }
            });
            keyIndicators.forEach((indicator, index) => {
                indicator.classList.toggle('hittable', hittableLanes[index]);
            });
        }
        updateUI = function() {
            scoreDisplay.textContent = `üèÜ ${score}`;
            comboDisplay.textContent = `üî• x${combo}`;
            livesDisplay.textContent = '‚ù§Ô∏è'.repeat(lives);
            shieldIcon.classList.toggle('active', hasShield);
            if (!isFeverTime) {
                feverBar.style.width = `${(feverMeter / FEVER_MAX) * 100}%`;
            }
        }
        createFloatingText = function(text, element, color) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.color = color;
            const rect = element.getBoundingClientRect(), containerRect = gameContainer.getBoundingClientRect();
            el.style.left = `${rect.left - containerRect.left + rect.width / 2 - 30}px`;
            el.style.top = `${rect.top - containerRect.top}px`;
            gameContainer.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        createHitParticles = function(count, element) {
            const rect = element.getBoundingClientRect(), containerRect = gameContainer.getBoundingClientRect();
            const startX = rect.left - containerRect.left + rect.width / 2;
            const startY = rect.top - containerRect.top + rect.height / 2;
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.textContent = '‚òÖ';
                p.style.fontSize = `${10 + Math.random() * 15}px`;
                p.style.left = `${startX}px`; p.style.top = `${startY}px`;
                const angle = Math.random() * 2 * Math.PI, dist = Math.random() * 40 + 20;
                const x = Math.cos(angle) * dist, y = Math.sin(angle) * dist;
                p.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${x}px, ${y}px) scale(0)`, opacity: 0 }
                ], { duration: 700 + Math.random() * 300, easing: 'ease-out' });
                gameContainer.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }
        createFeverParticle = function() {
            const p = document.createElement('div');
            p.className = 'particle';
            p.textContent = '‚ú®';
            p.style.fontSize = `${15 + Math.random() * 15}px`;
            p.style.left = `${Math.random() * 100}%`;
            p.style.top = '105%';
            p.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: `translateY(-${gameContainer.clientHeight + 50}px)`, opacity: 0 }
            ], { duration: 2000 + Math.random() * 2000, easing: 'linear' });
            gameContainer.appendChild(p);
            setTimeout(() => p.remove(), 4000);
        }
    </script>
</body>
</html>
